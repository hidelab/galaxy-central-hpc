define(["mvc/collection/dataset-collection-base","mvc/dataset/hda-base","mvc/base-mvc","utils/localization"],function(f,a,b,e){var d=Backbone.View.extend(b.LoggableMixin).extend({tagName:"div",className:"history-panel",fxSpeed:"fast",initialize:function(g){g=g||{};if(g.logger){this.logger=g.logger}this.log(this+".initialize:",g);this.hasUser=g.hasUser;this.HDAViewClass=g.HDAViewClass||a.HDABaseView},_setUpListeners:function(){this.on("all",function(g){this.log(this+"",arguments)},this);return this},_setUpModelEventHandlers:function(){return this},render:function(i,j){this.log("render:",i,j);i=(i===undefined)?(this.fxSpeed):(i);var g=this,h;if(!this.model){return this}h=this.renderModel();$(g).queue("fx",[function(k){if(i&&g.$el.is(":visible")){g.$el.fadeOut(i,k)}else{k()}},function(k){g.$el.empty();if(h){g.$el.append(h.children())}k()},function(k){if(i&&!g.$el.is(":visible")){g.$el.fadeIn(i,k)}else{k()}},function(k){if(j){j.call(this)}g.trigger("rendered",this);k()}]);return this},renderModel:function(){var g=$("<div/>").append(d.templates.panel(this.model.toJSON()));this._setUpBehaviours(g);this.renderContents(g);return g},_setUpBehaviours:function(g){g=g||this.$el;g.find("[title]").tooltip({placement:"bottom"});return this},$container:function(){return(this.findContainerFn)?(this.findContainerFn.call(this)):(this.$el.parent())},$datasetsList:function(g){return(g||this.$el).find(".datasets-list")},renderContents:function(h){h=h||this.$el;var g=this,j={},i=this.model.elements||[];this.$datasetsList(h).empty();if(i&&i.length){i.each(function(l){var m=l.id,k=g._createContentView(l);j[m]=k;g.attachContentView(k.render(),h)})}this.contentViews=j;return this.contentViews},_createContentView:function(i){var h=null,g=this._getContentClass(i);h=new g({model:i.object,linkTarget:this.linkTarget,hasUser:this.hasUser,logger:this.logger});return h},_getContentClass:function(g){switch(g.get("element_type")){case"hda":return this.HDAViewClass;case"dataset_collection":return f.NestedDCEBaseView}throw new TypeError("Unknown element type:",g.get("element_type"))},attachContentView:function(i,h){h=h||this.$el;var g=this.$datasetsList(h);g.append(i.$el);return this},events:{"click .panel-navigation-back":"close"},close:function(g){this.$el.remove();this.trigger("collection-close")},toString:function(){return"CollectionPanel("+((this.model)?(this.model.get("name")):(""))+")"}});var c=['<div class="history-controls">','<div class="panel-navigation">','<a class="panel-navigation-back" href="javascript:void(0)">',e("Back"),"</a>","</div>",'<div class="history-title">',"<% if( collection.name ){ %>",'<div class="history-name"><%= collection.hid %> : <%= collection.name %></div>',"<% } %>","</div>","</div>",'<div class="datasets-list"></div>'].join("");d.templates={panel:function(g){return _.template(c,g,{variable:"collection"})}};return{CollectionPanel:d}});